<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>Building a Simple Kernel - Aeryz's Blog</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Building a Simple Kernel | Aeryz’s Blog</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Building a Simple Kernel" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="For software geeks, created by a software geek." /> <meta property="og:description" content="For software geeks, created by a software geek." /> <meta property="og:site_name" content="Aeryz’s Blog" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Building a Simple Kernel" /> <script type="application/ld+json"> {"url":"/docs/os-dev-journey/simple-kernel.html","headline":"Building a Simple Kernel","description":"For software geeks, created by a software geek.","@type":"WebPage","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <link rel="icon" href="data:,"> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Aeryz's Blog </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Aeryz's Blog" aria-label="Search Aeryz's Blog" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/aeryz" class="site-button" target="_blank" rel="noopener noreferrer" > GitHub </a> </li> <li class="aux-nav-list-item"> <a href="//twitter.com/aeryz2" class="site-button" target="_blank" rel="noopener noreferrer" > Twitter </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="">OS Dev Journey</a></li> <li class="breadcrumb-nav-list-item"><span>Building a Simple Kernel</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="building-a-simple-kernel-for-ia-32"> <a href="#building-a-simple-kernel-for-ia-32" class="anchor-heading" aria-labelledby="building-a-simple-kernel-for-ia-32"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Building a Simple Kernel for IA-32 </h1> <h2 id="how-to-get-most-out-this-post"> <a href="#how-to-get-most-out-this-post" class="anchor-heading" aria-labelledby="how-to-get-most-out-this-post"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> How to get most out this post? </h2> <p>Before digging into some weird stuff, I want to share some thoughts to make sure that you are getting the most out of this blog post. First of all, this post really encourages you to make lots of research and read a lot. There are several reasons to that:</p> <ol> <li> <p>Getting used to reading official documentations is super benefitial and you will always find lots of hidden gems and hacks when you read official docs.</p> </li> <li> <p>Although there are few great resources about OS development, this is a field where you should find and figure out things by yourself.</p> </li> </ol> <p>Secondly, I will give you some hints and resources and ask you to stop and try it on your own. No matter how painful it is, please try those things yourself before going further. You may lose your mind but that’s the beauty of it :)</p> <p>That’s enough already, let’s dig into the real thing.</p> <h2 id="introduction"> <a href="#introduction" class="anchor-heading" aria-labelledby="introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Introduction </h2> <p>Before digging into more complex stuff like cpu scheduling, paging, etc. we should of course have a bootable kernel. You can do some research about the boot process, we will just make a kernel that supports Multiboot.</p> <h2 id="supporting-multiboot-specification"> <a href="#supporting-multiboot-specification" class="anchor-heading" aria-labelledby="supporting-multiboot-specification"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Supporting multiboot specification </h2> <p>Multiboot specification is an open standard describing how a boot loader can load an x86 operating system kernel<a href="https://en.wikipedia.org/wiki/Multiboot_specification">[*]</a>. This way, any boot loader that are able to load multiboot compliant kernel and we won’t need to write our own boot loader. Of course one can say that there is Linux, so we don’t need to write our own operating system. But it is fun and helps you to understand how real systems really work.</p> <p>There are few requirements in the <a href="https://www.gnu.org/software/grub/manual/multiboot/multiboot.html">specification</a> to make things work. First of all the specification says:</p> <blockquote> <p><em>The Multiboot header must be contained completely within the first 8192 bytes of the OS image, and must be longword (32-bit) aligned. In general, it should come as early as possible, and may be embedded in the beginning of the text segment after the real executable header.</em></p> </blockquote> <p>So we will make our header 32-bit aligned and put it as early as possible. The header fields that we will be using are:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Offset</th> <th>Type</th> <th>Field Name</th> </tr> </thead> <tbody> <tr> <td>0</td> <td>u32</td> <td>magic</td> </tr> <tr> <td>4</td> <td>u32</td> <td>flags</td> </tr> <tr> <td>8</td> <td>u32</td> <td>checksum</td> </tr> </tbody> </table></div> <p>Let’s start implementing this.</p> <p>I prefer the Intel syntax. Let’s use it.</p> <div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">.intel_syntax</span> <span class="nv">noprefix</span>
</code></pre></div></div> <p>After this, we can start putting our 4-byte aligned header.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.align 4                 # 1
.section .multiboot      # 2
.long 0x1BADB002         # 3
.long 0                  # 4
.long -(0x1BADB002 + 0)  # 5
</code></pre></div></div> <ol> <li>The multiboot header should be 32-bit (4 byte) aligned. So we aligned the section by using <code class="language-plaintext highlighter-rouge">.align</code> <a href="https://ftp.gnu.org/old-gnu/Manuals/gas-2.9.1/html_chapter/as_7.html">directive</a></li> <li>We name this section as <code class="language-plaintext highlighter-rouge">.multiboot</code> and will be using this name later on to make sure that our header is 4-byte aligned and loaded very early in the executable file.</li> <li>Magic number that indicates multiboot 1.</li> <li>We don’t have any flags set. So we put 0.</li> <li>We put the checksum value. It should give 0, when added to the other magic fields.</li> </ol> <p>To be able to assemble <code class="language-plaintext highlighter-rouge">boot.s</code> for our bare bones x86 target, we need to use a cross-platform toolchain. We don’t want anything that depends on our host ecosystem. We can achieve this by using <code class="language-plaintext highlighter-rouge">binutils</code>.</p> <p>Let’s assemble <code class="language-plaintext highlighter-rouge">boot.s</code> and validate our multiboot header.</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>i386-elf-as <span class="nt">-msyntax</span><span class="o">=</span>intel <span class="nt">-mmnemonic</span><span class="o">=</span>intel boot.s <span class="nt">-o</span> boot.o
</code></pre></div></div> <p>As you can guess, <code class="language-plaintext highlighter-rouge">-msyntax</code> and <code class="language-plaintext highlighter-rouge">-mmnemonic</code> arguments are used for intel syntax.</p> <p>Validate the header:</p> <div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>grub-file <span class="nt">--is-x86-multiboot</span> boot.o <span class="o">||</span> <span class="nb">echo</span> <span class="s2">":("</span>
</code></pre></div></div> <p>If the command does not give us a sad face, then we are good to go.</p> <h2 id="running-some-code"> <a href="#running-some-code" class="anchor-heading" aria-labelledby="running-some-code"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Running some code </h2> <p>The boot loader will jump to the <code class="language-plaintext highlighter-rouge">_start</code> symbol. If we don’t define the <code class="language-plaintext highlighter-rouge">_start</code> symbol, the linker will provide it with a predefined location. Our super simple kernel would probably work if we won’t define the <code class="language-plaintext highlighter-rouge">_start</code> symbol. I will demonstrate what I mean later.</p> <div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">.section</span> <span class="nv">.text</span> <span class="err">#</span><span class="mi">1</span>
<span class="nf">.global</span> <span class="nv">_start</span> <span class="err">#</span><span class="mi">2</span>
<span class="nl">_start:</span> 
</code></pre></div></div> <ol> <li>Executable part of the binary goes into <code class="language-plaintext highlighter-rouge">.text</code> section.</li> <li>We make <code class="language-plaintext highlighter-rouge">_start</code> symbol accessible from outside of the file.</li> </ol> <p>Let’s print a very simple <code class="language-plaintext highlighter-rouge">Hi</code> message to see if everything works fine. Since we don’t have any underlying OS (basically we are the OS), we don’t have anything like <code class="language-plaintext highlighter-rouge">printf</code> or <code class="language-plaintext highlighter-rouge">write</code> system call. Because the system calls are provided by the operating system. We need to implement such things ourselves in this wild, bare bones environment.</p> <p>We will use the <a href="https://en.wikipedia.org/wiki/VGA_text_mode">VGA text mode</a> to print to screen. The one we will be using in <code class="language-plaintext highlighter-rouge">qemu</code> provides a <code class="language-plaintext highlighter-rouge">80x25 16-bit</code> buffer located at physical memory address <code class="language-plaintext highlighter-rouge">0xB8000</code>. Layout of a character is like this:</p> <div class="table-wrapper"><table> <thead> <tr> <th>Bits</th> <th>Description</th> </tr> </thead> <tbody> <tr> <td>0-7</td> <td>Code point</td> </tr> <tr> <td>8-11</td> <td>Foreground color</td> </tr> <tr> <td>12-15</td> <td>Background color</td> </tr> </tbody> </table></div> <p>You can also check out the 4-bit color palette <a href="https://www.fountainware.com/EXPL/vga_color_palettes.htm">here</a>.</p> <p>To print a white-on-black <code class="language-plaintext highlighter-rouge">HI</code> message, we need to do a small math.</p> <div class="language-nasm highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nf">.section</span> <span class="nv">.text</span>
<span class="nf">.global</span> <span class="nv">_start</span>
<span class="nl">_start:</span>
    <span class="nf">mov</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="mh">0xb8000</span><span class="p">],</span> <span class="s">'h'</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    <span class="nf">mov</span> <span class="kt">word</span> <span class="nv">ptr</span> <span class="p">[</span><span class="mh">0xb8000</span> <span class="o">+</span> <span class="mh">0x2</span><span class="p">],</span> <span class="s">'i'</span> <span class="o">|</span> <span class="p">(</span><span class="mh">0xF</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span>
    
    <span class="nf">hlt</span>
</code></pre></div></div> <p>We basically left-shift the foreground color (WHITE) by 8 bits and OR it with <code class="language-plaintext highlighter-rouge">h</code> and <code class="language-plaintext highlighter-rouge">i</code> to get white-on-black characters and put it to physical address <code class="language-plaintext highlighter-rouge">0xb8000</code> which is the address of the VGA buffer.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
