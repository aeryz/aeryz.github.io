<!DOCTYPE html> <html lang="en-US"> <head> <meta charset="UTF-8"> <meta http-equiv="X-UA-Compatible" content="IE=Edge"> <title>2. Long Mode - Aeryz's Blog</title> <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"> <link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script type="text/javascript" src="/assets/js/vendor/lunr.min.js"></script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script> <meta name="viewport" content="width=device-width, initial-scale=1"> <!-- Begin Jekyll SEO tag v2.7.1 --> <title>Long Mode | Aeryz’s Blog</title> <meta name="generator" content="Jekyll v4.2.0" /> <meta property="og:title" content="Long Mode" /> <meta property="og:locale" content="en_US" /> <meta name="description" content="For software geeks, created by a software geek." /> <meta property="og:description" content="For software geeks, created by a software geek." /> <meta property="og:site_name" content="Aeryz’s Blog" /> <meta name="twitter:card" content="summary" /> <meta property="twitter:title" content="Long Mode" /> <script type="application/ld+json"> {"url":"/docs/os-dev-journey/long-mode.html","headline":"Long Mode","description":"For software geeks, created by a software geek.","@type":"WebPage","@context":"https://schema.org"}</script> <!-- End Jekyll SEO tag --> <link rel="icon" href="data:,"> </head> <body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"> <title>Link</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"> <path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"> <title>Search</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"> <title>Menu</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"> <line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"> <title>Expand</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"> <polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"> <title>Document</title> <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"> <path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg> <div class="side-bar"> <div class="site-header"> <a href="/" class="site-title lh-tight"> Aeryz's Blog </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a> </div> <nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"> <ul class="nav-list"><li class="nav-list-item"><a href="/" class="nav-list-link">Home</a></li><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="/blog/os-dev-journey" class="nav-list-link">OS Dev Journey</a><ul class="nav-list "><li class="nav-list-item "><a href="/docs/os-dev-journey/introduction.html" class="nav-list-link">1. Introduction</a></li><li class="nav-list-item active"><a href="/docs/os-dev-journey/long-mode.html" class="nav-list-link active">2. Long Mode</a></li></ul></li></ul> </nav> <footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll. </footer> </div> <div class="main" id="top"> <div id="main-header" class="main-header"> <div class="search"> <div class="search-input-wrap"> <input type="text" id="search-input" class="search-input" tabindex="0" placeholder="Search Aeryz's Blog" aria-label="Search Aeryz's Blog" autocomplete="off"> <label for="search-input" class="search-label"><svg viewBox="0 0 24 24" class="search-icon"><use xlink:href="#svg-search"></use></svg></label> </div> <div id="search-results" class="search-results"></div> </div> <nav aria-label="Auxiliary" class="aux-nav"> <ul class="aux-nav-list"> <li class="aux-nav-list-item"> <a href="//github.com/aeryz" class="site-button" target="_blank" rel="noopener noreferrer" > GitHub </a> </li> <li class="aux-nav-list-item"> <a href="//twitter.com/aeryz2" class="site-button" target="_blank" rel="noopener noreferrer" > Twitter </a> </li> </ul> </nav> </div> <div id="main-content-wrap" class="main-content-wrap"> <nav aria-label="Breadcrumb" class="breadcrumb-nav"> <ol class="breadcrumb-nav-list"> <li class="breadcrumb-nav-list-item"><a href="/blog/os-dev-journey">OS Dev Journey</a></li> <li class="breadcrumb-nav-list-item"><span>2. Long Mode</span></li> </ol> </nav> <div id="main-content" class="main-content" role="main"> <h1 id="entering-long-mode"> <a href="#entering-long-mode" class="anchor-heading" aria-labelledby="entering-long-mode"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Entering Long Mode </h1> <p>To be able to use the features that comes with the long mode (such as 64-bit registers, multimedia registers, memory addresses that are higher than 4GiB), <a href="https://wiki.osdev.org/Setting_Up_Long_Mode">the long mode</a> should be enabled.</p> <p>Before enabling the long mode, we should first check if it is supported by the CPU. First step is to detect if CPUID is supported. We use CPUID to check if long mode is supported.</p> <p>To detect the support for CPUID, we need to if 21. bit of <code class="language-plaintext highlighter-rouge">EFLAGS</code> can be modified. There are two notable instructions here:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>pushfd ; push eflags to the stack
popfd  ; pop eflags from the stack
</code></pre></div></div> <p>After this, CPUID should be called with the correct argument to check for the long mode support. CPUID accepts its argument from <code class="language-plaintext highlighter-rouge">eax</code> register.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mov eax, 0x80000000    ; Set the A-register to 0x80000000.
cpuid                  ; CPU identification.
cmp eax, 0x80000001    ; Compare the A-register with 0x80000001.
jb .NoLongMode
</code></pre></div></div> <p>This code from <a href="https://wiki.osdev.org/Setting_Up_Long_Mode#x86_or_x86-64">OSDev</a> is calling <code class="language-plaintext highlighter-rouge">cpuid</code> with an argument to <a href="https://en.wikipedia.org/wiki/CPUID#EAX=80000000h:_Get_Highest_Extended_Function_Implemented">get highest extended function implemented</a>. If the returned value is smaller than <code class="language-plaintext highlighter-rouge">0x80000001</code>, we understand that the long mode is not supported.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mov eax, 0x80000001    ; Set the A-register to 0x80000001.
cpuid                  ; CPU identification.
test edx, 1 &lt;&lt; 29      ; Test if the LM-bit, which is bit 29, is set in the D-register.
jz .NoLongMode         ; They aren't, there is no long mode.
</code></pre></div></div> <p>Then the next code from <a href="https://wiki.osdev.org/Setting_Up_Long_Mode#x86_or_x86-64">OSDev</a> is calling <code class="language-plaintext highlighter-rouge">cpuid</code> again to get the <a href="https://en.wikipedia.org/wiki/CPUID#EAX=80000001h:_Extended_Processor_Info_and_Feature_Bits">extended processor info and feature bits</a> which returns the feature flags in <code class="language-plaintext highlighter-rouge">edx</code> and <code class="language-plaintext highlighter-rouge">ecx</code> registers. We check the 29. bit of <code class="language-plaintext highlighter-rouge">edx</code> to see if the long mode is supported.</p> <p>To have fun, I also wanted to print the vendor name of cpu. To get that information, we need to call <code class="language-plaintext highlighter-rouge">cpuid</code> with <code class="language-plaintext highlighter-rouge">eax = 0</code>, which returns the manufacturer id in <code class="language-plaintext highlighter-rouge">ebx</code>, <code class="language-plaintext highlighter-rouge">ecx</code> and <code class="language-plaintext highlighter-rouge">edx</code>. So we can write a function to call <code class="language-plaintext highlighter-rouge">cpuid</code> and print those 12 bytes to the screen.</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>print_cpu_vendor:
	mov eax, 0
	cpuid
    
    ; push the returned characters with the correct order to stack so that 
    ; we can easily iterate through them and be able to use the registers
	push ebx
	push ecx
	push edx

    ; for each character, we move the character to the vga buffer with the correct
    ; color code (in this case we use 0x2f for green background and white foreground)
	mov ecx, 0
.pcv_loop:
	cmp ecx, 12
	je .pcv_end
	mov al, byte [esp + ecx]
	mov ebx, 0xb8000
	lea edx, [ecx * 2]
	add ebx, edx
	mov byte [ebx], al
	add ebx, 1
	mov byte [ebx], 0x2f
	add ecx, 1
	jmp .pcv_loop
.pcv_end:
    ; never forget to clean your mess
	pop eax
	pop eax
	pop eax
	ret
</code></pre></div></div> <h2 id="next-step"> <a href="#next-step" class="anchor-heading" aria-labelledby="next-step"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Next Step </h2> <p>I will continue with <a href="https://os.phil-opp.com/entering-longmode/">Entering Long Mode</a> post.</p> </div> </div> <div class="search-overlay"></div> </div> </body> </html>
